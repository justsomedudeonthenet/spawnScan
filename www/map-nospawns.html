<!DOCTYPE html>
<html>
	<head>
		<style>
			#map {
			width: 100%;
			height: 100%;
			margin: 0;
            padding: 0;
            position: absolute;
			left: 0px;
			top: 0px;
			}

			#legend {
				background: #fff;
				padding: 10px;
				margin: 10px;
				border: 1px solid #000;
			}
			#legend h3 {
				margin-top: 0;
			}
		</style>
		<script src="./static/klokantech.js"></script>
	</head>
	<body>
		<div id="map"></div>
		<div id="legend"><h3>Legend</h3></div>
		<script>
			function getFile(path, asynch, callback) {
				var xhr = new XMLHttpRequest();
				xhr.overrideMimeType("application/json");
				xhr.open("GET", path, asynch);
				xhr.onload = function (e) {
					if (xhr.readyState === 4) {
						callback(xhr.responseText);
					}
				};
				xhr.onerror = function (e) {
					console.error(xhr.status);
				};
				xhr.send(null);
			}
			
			var gym;
			var stop;
			var gymsLayer;
			var stopsLayer;
			var map;
			function initMap() {
				gym = {url: "./static/gym.png",size: new google.maps.Size(30, 30),anchor: new google.maps.Point(15,30)};
				stop = {url: "./static/pokestop.png",size: new google.maps.Size(30, 30),anchor: new google.maps.Point(15, 30)};
				infowindow = new google.maps.InfoWindow();
				
				var mapDiv = document.getElementById('map');
				map = new google.maps.Map(mapDiv, {
					center: {lat: 43.1534, lng: -80.2484},
					zoom: 14,
				});

				// Show scanned area
				getFile('./config.php', true, function(response) {
					var data = JSON.parse(response);
					for (var i = 0; i < data.length; i++) {
						var p = data[i];
						new google.maps.Rectangle({
							strokeColor: '#FF0000',
							strokeOpacity: 0.3,
							strokeWeight: 1,
							fillOpacity: 0,
							map: map,
							bounds: {
								north: p['north'],
								south: p['south'],
								east: p['east'],
								west: p['west']
							}
						});
					}
				});

				var geoloccontrol = new klokantech.GeolocationControl(map, 18);

				gymsLayer = new google.maps.Data();
				stopsLayer = new google.maps.Data();

				gymsLayer.loadGeoJson('./geo_gyms.json');
				gymsLayer.setStyle(function(feature) {
					return {icon: gym};
				});
				gymsLayer.setMap(map);
				gymsLayer.addListener('click', function(event) {
					infowindow.setContent(event.feature.getProperty('name'));
					infowindow.setPosition(event.latLng);
					infowindow.setOptions({pixelOffset: new google.maps.Size(0,-34)});
					infowindow.open(map);
				});
				
				stopsLayer.loadGeoJson('./geo_stops.json');
				stopsLayer.setStyle(function(feature) {
					return {icon: stop};
				});
				stopsLayer.setMap(map);
				stopsLayer.addListener('click', function(event) {
					infowindow.setContent(event.feature.getProperty('name'));
					infowindow.setPosition(event.latLng);
					infowindow.setOptions({pixelOffset: new google.maps.Size(0,-34)});
					infowindow.open(map);
				});
				
				var legenditems = {
					gyms: {
						name: 'Gyms',
						icon: './static/gym.png',
						layer: 'gymsLayer'
					},
					pokestops: {
						name: 'Pokestops',
						icon: './static/pokestop.png',
						layer: 'stopsLayer'
					},
				};



				var legend = document.getElementById('legend');
					for (var key in legenditems) {
						var type = legenditems[key];
						var name = type.name;
						var icon = type.icon;
						var layer = type.layer;
						var div = document.createElement('div');
						div.innerHTML = '<input checked="checked" type="checkbox" onchange="toggleType(this, event, \'' + key + '\')">' + name + '<img src="' + icon + '">';
						legend.appendChild(div);
				}
				map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);
				google.maps.event.addListener(map, 'click', function() { infowindow.close(); });
			}

			function toggleType(elm, event, type) {
				if(type == 'gyms') {
					gymsLayer.setMap( elm.checked ? map : null);
				} else if (type == 'pokestops') {
					stopsLayer.setMap( elm.checked ? map : null);
				}
			}

		</script>
		<script async defer
			src="https://maps.googleapis.com/maps/api/js?key=API_KEY_HERE&callback=initMap">
		</script>
	</body>
</html>
